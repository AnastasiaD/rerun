#!/bin/bash

# Source common function library
. $RERUN_MODULES/stubbs/lib/functions.sh

# print an error and exit
die() { echo "ERROR: \$* " ; exit 1; }

rerun_init

# Get the options
while [ "$#" -gt 0 ]; do
    OPT="$1"
    case "$OPT" in
        # options without arguments
	# options with arguments
	-name)
	    rerun_syntax_check "$#"
	    NAME="$2"
	    shift
	    ;;
	-description)
	    rerun_syntax_check "$#"
	    DESC="$2"
	    shift
	    ;;
        # unknown option
	-?)
	    rerun_syntax_error
	    ;;
	  # end of options, just arguments left
	*)
	    break
    esac
    shift
done

# Post processes the options
[ -z "$NAME" ] && {
    echo "Module name: "
    read NAME
}

[ -z "$DESC" ] && {
    echo "Module description: "
    read DESC
}

# Create module structure
mkdir -p $RERUN_MODULES/$NAME || die
# Create etc/ subdirectory
mkdir -p $RERUN_MODULES/$NAME/etc || die
# Create commands/ subdirectory
mkdir -p $RERUN_MODULES/$NAME/commands || die

# Generate a profile for metadata
(
cat <<EOF
# generated by add-module
# $(date)
NAME=$NAME
DESCRIPTION="$DESC"

EOF
) > $RERUN_MODULES/$NAME/metadata || die


# Done
echo "Created module structure: $RERUN_MODULES/$NAME"
