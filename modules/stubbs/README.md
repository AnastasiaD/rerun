# stubbs: A module and command set to create rerun modules

Use `stubbs` to define new *rerun* modules and commands.

Stubbs provides a small set of commands that 
help you define and organize modules according to
rerun layout conventions and metadata format. 

It won't write your implementations for you but
helps you stay in between the guard rails!

## Commands

### add-module

Create a new rerun module.

*Usage*

    rerun -m stubbs -c add-module -- [-name <>] [-description <>]
    
*Example*

Make a new module named "freddy":

    rerun -m stubbs -c add-module  -- -name freddy -description "A dancer in a red beret and matching suspenders"

The `add-module` command will print:

    Created module structure: /Users/alexh/.rerun/modules/freddy

### add-command

Create a command in the specified module.

*Usage*

    rerun -m stubbs -c add-command -- -name <> -description <> -module <> [-ovewrite <false>]

*Example*

Add a command named "dance" to the freddy module:

    rerun -m stubbs -c add-command -- -name dance -description "tell freddy to dance" -module freddy

The `add-command `module will generate a boilerplate script you can edit.

    Wrote command handler: /Users/alexh/.rerun/modules/freddy/commands/dance/default.sh

### add-option

Define a command option for the specified module.

*Usage*

    rerun -m stubbs -c add-option  -- [-arg <true>] -name <> -description <> -module <> -command <> [-required <false>]

*Example*

Define an option named "jumps":

    rerun -m stubbs -c add-option  -- -name jumps -description "jump #num times" -module freddy -command dance

You will see output similar to:

    Created option: /Users/alexh/.rerun/modules/freddy/commands/dance/jumps.option

Besides the `jumps.option` file, `add-option` will also generate an
option parser script: `$RERUN_MODULES/$MODULE/commands/$COMMAND/options.sh`.

## Command implementation

Running `add-command` as shown above will generate a stub implementation
for the new command: `$RERUN_MODULES/$MODULE/commands/$COMMAND/default.sh`:

The dance command's `default.sh` stub is shown below:

    #!/bin/bash
    #
    # NAME
    #
    #   dance 
    #
    # DESCRIPTION
    #
    #   tell freddy to dance
     
    # Function to print error message and exit
    die() {
        echo "ERROR: $* " ; exit 1;
    }
     
    # Parse the command options     
    [ -r $RERUN_MODULES/freddy/commands/dance/options.sh ] && {
       . $RERUN_MODULES/freddy/commands/dance/options.sh
    } 
    # Available option variables: [JUMPS]
     
    # ------------------------------
    # Your implementation goes here.
    # ------------------------------
     
    exit $?

The name and description supplied via `add-command` options
are shown in the top comment.

A `die` function is provided for convenience in case things go awry.

Rather than implement a specialized option parser logic inside
each command implementation, stubbs generates a script that contains
the code which can be sourced, if it readable.
The stub script sources a file called `options.sh`
that parses the command options (i.e., those following the "--").

A list of variable names set by the option parsing script
is listed for convenient reference. "JUMPS" will be
set to the value defined by `-jumps <>`.

Naturally, your implementation goes between the rows
of dashes. 
For this example, `echo "jumps ($JUMPS)` is the trivial
implementation:

    # ------------------------------
    echo "jumps ($JUMPS)"
    # ------------------------------
    
    exit $?

Always faithfully check and return useful exit codes!

Try running the command:

    $ rerun -m freddy -c dance -- -jumps 3
    jumps (3)

The "jumps (3)" is written to the console stdout.

### Option defaults

If a command option is not set by the user, the option
can be set to a default value.

Use add-option's `-default <>` parameter to set the value. 
Here the "jumps" option is set to a default value, "1":

    rerun -m stubbs -c add-option  -- \
      -name jumps -description "jump #num times" -module freddy -command dance \
      -default 1

Run the "dance" command again but this time without the "jumps" option:

    $ rerun -m freddy -c dance
    jumps (1)
    
Behind the scenes, the "dance" command's `options.sh` script is generated
by `add-options`.
The `options.sh` script defines a while loop and supporting shell functions
to process command line input.


    # generated by add-option
    # Tue Sep 13 20:11:52 PDT 2011
     
    # print error message and exit non-zero
    arg_syntax_error() {
        echo "SYNTAX ERROR" >&2 ; exit 2;
    }
    # check option has its argument
    arg_syntax_check() {
        [ "$1" -lt 2 ] && syntax_error
    }
     
    # options: [jumps]
    while [ "$#" -gt 0 ]; do
        OPT="$1"
        case "$OPT" in
            -jumps) arg_syntax_check $# ; JUMPS=$2 ; shift ;;
            # unknown option
            -?)
                arg_syntax_error
                ;;
            # end of options, just arguments left
            *)
              break
        esac
        shift
    done
          
    # If cli options unset, set them to default value
    [ -z "$JUMPS" ] && { JUMPS=1 ; }
     
Below the `while` loop, option variables are set to default
values. Note, this is only done for options that declare 
`DEFAULT` metadata.

Separating options processing in the `options.sh` script
from the main implementation logic in `default.sh`, facilates
"stubbs" commands from preserving your code.


### OS specific command implementations

Rerun will look for an operating system specific implementation
and run it instead, if it exists.
Effectively, it looks for a file called: 
`$MODULE/commands/$COMMAND/$(uname -s).sh`

For example, on a centos host running `uname -s` returns "Linux".

    $ uname -s
    Linux

Therefore to create a Linux OS specific implmentation,
create a script called `Linux.sh` in the command directory.

    freddy
    └── commands
        └── dance
            ├── Linux.sh (os-specific implementation)
            └── default.sh (generic one)
	    
	    
