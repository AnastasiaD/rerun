#!/usr/bin/env bash
#
# NAME
#
#   add-module
#
# DESCRIPTION
#
#   add a new module
#
#/ usage: stubbs:add-module --language|-l <sh> --module|-m <> --description <>

# Source common function library
. $RERUN_MODULE_DIR/lib/functions.sh || { echo >&2 "failed loading function library" ; exit 1 ; }

stubbs_init

# Get the options
while [ "$#" -gt 0 ]; do
    OPT="$1"
    case "$OPT" in
        # options without arguments
	# options with arguments
	-l|--language)
	    rerun_option_check "$#" "$1"
	    INTERPRETER="$2"
	    shift
	    ;;
	-m|--module)
	    rerun_option_check "$#" "$1"
	    MODULE="$2"
	    shift
	    ;;
	--description)
	    rerun_option_check "$#" "$1"
	    DESC="$2"
	    shift
	    ;;
        # unknown option
	-?)
	    rerun_option_usage
        exit 2
	    ;;
	  # end of options, just arguments left
	*)
	    break
    esac
    shift
done

# Post processes the options
[ -z "$MODULE" ] && {
    echo "Module name: "
    read MODULE
}

[ -z "$DESC" ] && {
    echo "Module description: "
    read DESC
}

: ${INTERPRETER:=bash}
[ ! -f $RERUN_MODULE_DIR/lib/$INTERPRETER/metadata ] && rerun_die "language unsupported: $INTERPRETER"

.  $RERUN_MODULE_DIR/lib/$INTERPRETER/metadata || rerun_die "error reading  $RERUN_MODULE_DIR/lib/$INTERPRETER/metadata "

[ -z "$RERUN_FUNCTION_LIB" ] && rerun_die "required metadata not found: RERUN_FUNCTION_LIB"


# Create module structure
mkdir -p $RERUN_MODULES/$MODULE || rerun_die
# Create commands/ subdirectory
mkdir -p $RERUN_MODULES/$MODULE/commands || rerun_die
# Create lib/ subdirectory
mkdir -p $RERUN_MODULES/$MODULE/lib || rerun_die

# Generate a profile for metadata
(
cat <<EOF
# generated by stubbs:add-module
# $(date)
NAME=$MODULE
DESCRIPTION="$DESC"
INTERPRETER="$INTERPRETER"
VERSION=
REQUIRES=

EOF
) > $RERUN_MODULES/$MODULE/metadata || rerun_die

# Give it the beginnings of a function library.
# Replace the word "@MODULE@" with the module's given name.
sed "s/@MODULE@/$MODULE/g" $RERUN_MODULE_DIR/lib/$INTERPRETER/templates/$RERUN_FUNCTION_LIB \
    > $RERUN_MODULES/$MODULE/lib/$RERUN_FUNCTION_LIB || rerun_die


# Done
echo "Created module structure: $RERUN_MODULES/$MODULE"
