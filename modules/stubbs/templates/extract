#!/bin/bash
#
# this is a self contained self extracting rerun 
#

# Function to print error message and exit
die() { echo "ERROR: $* " ; exit 1 ; }

# extracted payload goes in here
export TMPDIR=`mktemp -d /tmp/rerun.bsx.XXXXXX` || die 

ARCHIVE=`awk '/^__ARCHIVE_BELOW__/ {print NR + 1; exit 0; }' $0`

# Extraction time!
# - read lines from delimiter and pass to tar unarchive
tail -n+$ARCHIVE $0 | tar xz -C $TMPDIR || die

# CWD and TMDIR are passed to launcher as env variables
export CWD=`pwd`
export TMPDIR

# Change directory to the temp directory
cd $TMPDIR || die

# Run the launcher !
bash ./launcher $*
RETVAL=$?

# Go back to original working directory
cd $CWD

# Clean up after ourselves
rm -rf $TMPDIR

# Stop this script from executing before we reach the binary archive!
exit ${RETVAL:=0}

__ARCHIVE_BELOW__
